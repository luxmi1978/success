import React, { useEffect, useMemo, useRef, useState } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { Heart, PartyPopper, Music2, Pause, Play, Gift, Sparkles, Share2, Clock, Camera, Star, Calendar, Download, Cake } from "lucide-react";
import Confetti from "react-confetti";

/**
 * ðŸŽ‰ Birthday Wish â€“ Advanced UX/UI One-Pager
 * Technologies: React + Tailwind + Framer Motion + Lucide Icons + CSS effects
 * Features:
 *  - Animated gradient hero with floating balloons/hearts
 *  - Name reveal + typewriter line + live confetti
 *  - Magic buttons with microinteractions & soft glassmorphism
 *  - Memory gallery (auto-play carousel) with 3D hover tilt
 *  - Timeline of moments with subtle parallax
 *  - Countdown to the next birthday (auto-calculated)
 *  - Love letter card with handwriting font
 *  - Music toggle (no autoplay with sound, user gesture required)
 *  - Share/download image of hero section
 *  - Fully responsive & print-friendly
 *
 * â–¶ How to customize (search & replace):
 *   - celebrantName: Person you love
 *   - fromName: Your name
 *   - birthdayMonth/day: Month & day of their birthday
 *   - galleryImages: Replace URLs with your images
 *   - loveLetter: Write your message
 */

// ====== âœ¨ Customize here âœ¨ ======
const celebrantName = "My Forever Love"; // e.g., "Ariana"
const fromName = "â€” Yours, Arpa";        // your sign-off
const birthdayMonth = 10; // 1-12
const birthdayDay = 14;   // 1-31

const loveLetter = `
Happy Birthday, my sunshine! ðŸŒž

Every day with you feels like a small festivalâ€”soft laughter, warm hugs,
and tiny sparks of magic. You make colors brighter and moments deeper.

On your special day, Iâ€™m wishing you a year full of peace, growth,
and silly, endless smiles. Thank you for choosing me in a world
full of choices. I love youâ€”today, tomorrow, always.
`;

const galleryImages = [
  { src: "https://images.unsplash.com/photo-1511735111819-9a3f7709049c?q=80&w=1400&auto=format&fit=crop", caption: "Your smile, my sunrise" },
  { src: "https://images.unsplash.com/photo-1529336953121-a4177b377eda?q=80&w=1400&auto=format&fit=crop", caption: "Tiny adventures" },
  { src: "https://images.unsplash.com/photo-1517816743773-6e0fd518b4a6?q=80&w=1400&auto=format&fit=crop", caption: "Coffee & confessions" },
  { src: "https://images.unsplash.com/photo-1519681393784-d120267933ba?q=80&w=1400&auto=format&fit=crop", caption: "Starry talks" },
];
// ====== /Customize ======

function useCountdown(month, day) {
  const [now, setNow] = useState(new Date());
  useEffect(() => {
    const t = setInterval(() => setNow(new Date()), 1000);
    return () => clearInterval(t);
  }, []);

  const target = useMemo(() => {
    const year = now.getMonth() + 1 > month || (now.getMonth() + 1 === month && now.getDate() > day)
      ? now.getFullYear() + 1
      : now.getFullYear();
    return new Date(year, month - 1, day, 0, 0, 0);
  }, [now, month, day]);

  const diff = target - now;
  const s = Math.max(0, Math.floor(diff / 1000));
  const days = Math.floor(s / 86400);
  const hours = Math.floor((s % 86400) / 3600);
  const minutes = Math.floor((s % 3600) / 60);
  const seconds = s % 60;
  return { target, days, hours, minutes, seconds };
}

const floaties = Array.from({ length: 18 }).map((_, i) => ({
  id: i,
  x: Math.random() * 100,
  size: 16 + Math.random() * 28,
  delay: Math.random() * 8,
  duration: 10 + Math.random() * 12,
  type: Math.random() > 0.5 ? "heart" : "balloon",
}));

function Floaties() {
  return (
    <div className="pointer-events-none absolute inset-0 overflow-hidden">
      {floaties.map((f) => (
        <motion.div
          key={f.id}
          initial={{ y: "100%", x: `${f.x}%`, opacity: 0 }}
          animate={{ y: "-20%", opacity: 0.9 }}
          transition={{ duration: f.duration, repeat: Infinity, delay: f.delay, ease: "easeInOut" }}
          className="absolute"
        >
          <div
            className={
              "flex items-center justify-center rounded-full/" +
              (f.type === "heart" ? "" : "")
            }
          >
            {f.type === "heart" ? (
              <Heart className="w-6 h-6 opacity-80" />
            ) : (
              <Balloon />
            )}
          </div>
        </motion.div>
      ))}
    </div>
  );
}

function Balloon() {
  return (
    <div className="relative">
      <div className="w-5 h-6 rounded-full bg-pink-400/70 blur-[0.2px]" />
      <div className="w-px h-5 bg-pink-300/60 mx-auto -mt-1" />
    </div>
  );
}

function useTypewriter(text, speed = 40) {
  const [out, setOut] = useState("");
  useEffect(() => {
    let i = 0;
    const t = setInterval(() => {
      setOut(text.slice(0, i + 1));
      i++;
      if (i >= text.length) clearInterval(t);
    }, speed);
    return () => clearInterval(t);
  }, [text, speed]);
  return out;
}

function useWindowSize() {
  const [size, setSize] = useState({ width: window.innerWidth, height: window.innerHeight });
  useEffect(() => {
    const onResize = () => setSize({ width: window.innerWidth, height: window.innerHeight });
    window.addEventListener("resize", onResize);
    return () => window.removeEventListener("resize", onResize);
  }, []);
  return size;
}

function GlassCard({ children, className = "" }) {
  return (
    <div className={`rounded-2xl p-6 backdrop-blur-xl bg-white/10 shadow-xl ring-1 ring-white/20 ${className}`}>
      {children}
    </div>
  );
}

function useAudio(url) {
  const audioRef = useRef(null);
  const [playing, setPlaying] = useState(false);
  useEffect(() => {
    if (!audioRef.current) audioRef.current = new Audio(url);
    return () => {
      if (audioRef.current) {
        audioRef.current.pause();
        audioRef.current.src = "";
      }
    };
  }, [url]);
  const toggle = () => {
    if (!audioRef.current) return;
    if (playing) audioRef.current.pause();
    else audioRef.current.play();
    setPlaying(!playing);
  };
  return { toggle, playing };
}

function useShareAsImage(ref) {
  const [busy, setBusy] = useState(false);
  const doShare = async () => {
    if (!ref.current) return;
    setBusy(true);
    const html2canvas = (await import("html2canvas")).default;
    const canvas = await html2canvas(ref.current, { backgroundColor: null, scale: 2 });
    canvas.toBlob(async (blob) => {
      const file = new File([blob], "happy-birthday.png", { type: "image/png" });
      if (navigator.share && navigator.canShare?.({ files: [file] })) {
        await navigator.share({ files: [file], title: "Happy Birthday" });
      } else {
        const url = URL.createObjectURL(file);
        const a = document.createElement("a");
        a.href = url; a.download = "happy-birthday.png"; a.click();
        URL.revokeObjectURL(url);
      }
      setBusy(false);
    });
  };
  return { doShare, busy };
}

export default function BirthdayWishSite() {
  const { width, height } = useWindowSize();
  const [confetti, setConfetti] = useState(false);
  const { days, hours, minutes, seconds, target } = useCountdown(birthdayMonth, birthdayDay);
  const subtitle = useTypewriter("You are my favorite reason to smile.");
  const heroRef = useRef(null);
  const { doShare, busy } = useShareAsImage(heroRef);
  const { toggle, playing } = useAudio("https://cdn.pixabay.com/audio/2022/03/15/audio_72b1c9c1c9.mp3");

  useEffect(() => {
    const t = setTimeout(() => setConfetti(true), 600);
    const tt = setTimeout(() => setConfetti(false), 6000);
    return () => { clearTimeout(t); clearTimeout(tt); };
  }, []);

  return (
    <div className="min-h-screen text-white selection:bg-pink-300/60 selection:text-black">
      {/* Animated background */}
      <div className="fixed inset-0 -z-10 bg-[radial-gradient(ellipse_at_top_left,rgba(255,150,197,0.35),transparent_50%),radial-gradient(ellipse_at_bottom_right,rgba(120,180,255,0.35),transparent_50%)]" />
      <div className="fixed inset-0 -z-10 animate-[gradientMove_15s_ease_infinite] bg-gradient-to-br from-fuchsia-500/20 via-pink-400/10 to-indigo-500/20" style={{ backgroundSize: "200% 200%" }} />

      {confetti && <Confetti width={width} height={height} numberOfPieces={260} recycle={false} />}

      {/* HERO */}
      <section ref={heroRef} className="relative flex min-h-[92vh] items-center justify-center px-6">
        <Floaties />
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.9 }}
          className="max-w-5xl w-full"
        >
          <GlassCard className="p-8 md:p-12 text-center">
            <motion.h1
              initial={{ scale: 0.96 }}
              animate={{ scale: 1 }}
              transition={{ type: "spring", stiffness: 120, damping: 12 }}
              className="text-4xl md:text-6xl font-black tracking-tight drop-shadow-sm"
            >
              Happy Birthday, <span className="bg-clip-text text-transparent bg-gradient-to-r from-amber-200 via-white to-pink-200">{celebrantName}</span>!
            </motion.h1>

            <p className="mt-4 text-lg md:text-xl text-white/90 font-medium min-h-[1.5em]">{subtitle}</p>

            <div className="mt-6 flex flex-wrap items-center justify-center gap-3">
              <button onClick={() => setConfetti(true)} className="group inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-white/15 hover:bg-white/25 ring-1 ring-white/20 transition">
                <PartyPopper className="w-5 h-5 group-hover:rotate-12 transition" />
                Celebrate
              </button>
              <button onClick={toggle} className="group inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-white/15 hover:bg-white/25 ring-1 ring-white/20 transition">
                <Music2 className="w-5 h-5" /> {playing ? "Pause" : "Play"} music
              </button>
              <button disabled={busy} onClick={doShare} className="group inline-flex items-center gap-2 rounded-2xl px-5 py-3 bg-white/15 hover:bg-white/25 ring-1 ring-white/20 transition disabled:opacity-60">
                <Share2 className="w-5 h-5" /> {busy ? "Preparing..." : "Share/Download"}
              </button>
            </div>

            <motion.div
              initial={{ opacity: 0, y: 10 }}
              whileInView={{ opacity: 1, y: 0 }}
              viewport={{ once: true }}
              transition={{ delay: 0.3 }}
              className="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs text-white/80"
            >
              <Stat icon={<Gift className="w-4 h-4" />} label="Wishes Sent" value="âˆž" />
              <Stat icon={<Sparkles className="w-4 h-4" />} label="Magic Level" value="Over 9000" />
              <Stat icon={<Heart className="w-4 h-4" />} label="Love Meter" value="100%" />
              <Stat icon={<Star className="w-4 h-4" />} label="Smiles Today" value="A lot" />
            </motion.div>
          </GlassCard>
        </motion.div>
      </section>

      {/* COUNTDOWN */}
      <section className="px-6 pb-10 -mt-8">
        <div className="max-w-5xl mx-auto">
          <GlassCard className="p-6 md:p-8">
            <div className="flex items-center gap-3 mb-3">
              <Clock className="w-5 h-5" />
              <h2 className="text-xl md:text-2xl font-bold">Countdown to your next birthday</h2>
            </div>
            <div className="grid grid-cols-4 gap-3 md:gap-6 text-center">
              <TimeBox label="Days" value={days} />
              <TimeBox label="Hours" value={hours} />
              <TimeBox label="Minutes" value={minutes} />
              <TimeBox label="Seconds" value={seconds} />
            </div>
            <p className="mt-3 text-sm text-white/80">Target: {target.toLocaleDateString()}</p>
          </GlassCard>
        </div>
      </section>

      {/* GALLERY */}
      <section className="px-6 pb-10">
        <div className="max-w-5xl mx-auto">
          <GlassCard>
            <div className="flex items-center gap-3 mb-4">
              <Camera className="w-5 h-5" />
              <h2 className="text-xl md:text-2xl font-bold">Little gallery of us</h2>
            </div>
            <Carousel images={galleryImages} />
          </GlassCard>
        </div>
      </section>

      {/* TIMELINE */}
      <section className="px-6 pb-10">
        <div className="max-w-5xl mx-auto">
          <GlassCard>
            <div className="flex items-center gap-3 mb-4">
              <Calendar className="w-5 h-5" />
              <h2 className="text-xl md:text-2xl font-bold">Moments that made us</h2>
            </div>
            <Timeline />
          </GlassCard>
        </div>
      </section>

      {/* LETTER */}
      <section className="px-6 pb-20">
        <div className="max-w-5xl mx-auto">
          <GlassCard className="relative overflow-hidden">
            <div className="absolute -top-10 -right-10 opacity-30 rotate-12">
              <Cake className="w-40 h-40" />
            </div>
            <h2 className="text-xl md:text-2xl font-bold mb-3 flex items-center gap-2"><Heart className="w-5 h-5" /> A little letter</h2>
            <p className="whitespace-pre-wrap font-[\'Handlee\',cursive] text-lg leading-8">
              {loveLetter}
            </p>
            <p className="mt-4 text-right italic opacity-90">{fromName}</p>
          </GlassCard>
        </div>
      </section>

      {/* FOOTER */}
      <footer className="px-6 pb-16">
        <div className="max-w-5xl mx-auto text-center text-sm text-white/80">
          Made with <Heart className="inline w-4 h-4" /> for {celebrantName}. Â© {new Date().getFullYear()}
        </div>
      </footer>

      <style>{`
        @keyframes gradientMove { 0%{background-position:0% 50%} 50%{background-position:100% 50%} 100%{background-position:0% 50%} }
        @import url('https://fonts.googleapis.com/css2?family=Handlee&display=swap');
      `}</style>
    </div>
  );
}

function Stat({ icon, label, value }) {
  return (
    <div className="rounded-xl p-4 bg-white/10 ring-1 ring-white/10">
      <div className="flex items-center gap-2 text-white/90">{icon}<span className="font-medium">{label}</span></div>
      <div className="text-2xl font-black mt-1">{value}</div>
    </div>
  );
}

function TimeBox({ label, value }) {
  return (
    <motion.div initial={{ y: 6, opacity: 0 }} whileInView={{ y: 0, opacity: 1 }} viewport={{ once: true }} className="rounded-xl p-4 bg-white/10 ring-1 ring-white/10">
      <div className="text-3xl md:text-4xl font-extrabold tabular-nums">{String(value).padStart(2, '0')}</div>
      <div className="mt-1 text-xs uppercase tracking-wider text-white/80">{label}</div>
    </motion.div>
  );
}

function Carousel({ images }) {
  const [i, setI] = useState(0);
  const next = () => setI((p) => (p + 1) % images.length);
  const prev = () => setI((p) => (p - 1 + images.length) % images.length);

  useEffect(() => {
    const t = setInterval(next, 3500);
    return () => clearInterval(t);
  }, []);

  return (
    <div className="relative">
      <div className="overflow-hidden rounded-2xl">
        <AnimatePresence mode="wait">
          <motion.div
            key={i}
            initial={{ opacity: 0, scale: 0.98 }}
            animate={{ opacity: 1, scale: 1 }}
            exit={{ opacity: 0, scale: 1.02 }}
            transition={{ duration: 0.5 }}
            className="relative"
          >
            <img src={images[i].src} alt={images[i].caption} className="w-full aspect-[16/9] object-cover" />
            <div className="absolute bottom-3 left-3 right-3 px-3 py-2 bg-black/30 backdrop-blur rounded-lg text-sm">{images[i].caption}</div>
          </motion.div>
        </AnimatePresence>
      </div>
      <div className="absolute inset-0 flex items-center justify-between p-3">
        <button onClick={prev} className="rounded-full bg-black/35 hover:bg-black/50 p-2 backdrop-blur">
          â€¹
        </button>
        <button onClick={next} className="rounded-full bg-black/35 hover:bg-black/50 p-2 backdrop-blur">
          â€º
        </button>
      </div>
      <div className="flex justify-center gap-2 mt-3">
        {images.map((_, idx) => (
          <span key={idx} className={`h-1.5 w-3 rounded-full ${idx === i ? 'bg-white' : 'bg-white/40'}`} />
        ))}
      </div>
    </div>
  );
}

function Timeline() {
  const items = [
    {
      title: "The Day We Met",
      desc: "A casual hello that changed everything.",
      when: "Our Chapter 1",
    },
    {
      title: "First Photo",
      desc: "Awkward pose, perfect memory.",
      when: "Soon after",
    },
    {
      title: "Inside Jokes",
      desc: "Laughs that only we understand.",
      when: "Everywhere",
    },
    {
      title: "Today",
      desc: "Celebrating your existence ðŸ’«",
      when: "Right now",
    },
  ];

  return (
    <div className="relative pl-4 md:pl-8">
      <div className="absolute left-2 md:left-4 top-0 bottom-0 w-px bg-white/20" />
      <div className="space-y-6">
        {items.map((it, idx) => (
          <motion.div key={idx} initial={{ x: -10, opacity: 0 }} whileInView={{ x: 0, opacity: 1 }} viewport={{ once: true }} transition={{ delay: idx * 0.05 }} className="relative">
            <div className="absolute -left-[7px] md:-left-[9px] top-2 w-3 h-3 md:w-3.5 md:h-3.5 rounded-full bg-white" />
            <div className="rounded-xl p-4 bg-white/10 ring-1 ring-white/10">
              <div className="text-sm text-white/80">{it.when}</div>
              <div className="text-lg font-bold">{it.title}</div>
              <div className="text-white/90">{it.desc}</div>
            </div>
          </motion.div>
        ))}
      </div>
    </div>
  );
}
